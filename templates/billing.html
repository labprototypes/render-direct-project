{% extends "base_app.html" %}

{% block title %}Управление подписками{% endblock %}

{% block content %}
<div class="app-container" style="display: block; padding-bottom: 40px;">

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="notice-bar" style="background-color: rgba(0, 123, 255, 0.1); border-color: rgba(0, 123, 255, 0.3);">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="billing-header" style="max-width: 1100px; margin: 0 auto 40px auto; align-items: stretch;">
        <div class="current-plan-info">
            <h1>Управление подписками</h1>
            
            <p>Ваш текущий план: 
                <strong>
                {% set plan_display_name = {
                    'taste': 'Стартер',
                    'best': 'Оптимальный',
                    'pro': 'Pifly PRO'
                } %}
                {% set display_name = plan_display_name.get(current_user.current_plan, 'Бесплатный') %}
                {{ display_name }}
                </strong>
            </p>

            <p>У вас есть <strong>{{ current_user.token_balance }}</strong> токенов.</p>
        </div>
        
        <div class="plan-card">
            <h3 class="plan-name">Пополнить баланс</h3>
            <p class="plan-description">Нужно больше токенов до старта следующего месяца?</p>
            <div class="plan-price">500₽</div>
            <ul class="plan-includes">
                <li class="available"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>Разовая покупка 1000 токенов</li>
            </ul>
            <form action="{{ url_for('create_payment') }}" method="POST">
                <input type="hidden" name="product_id" value="topup">
                <button type="submit" class="btn">Выбрать</button>
            </form>
        </div>
    </div>

    <hr style="width: 100%; max-width: 1100px; border-color: var(--border-color); margin: 40px auto;">

    <div class="plans-grid" style="max-width: 1100px; margin: 40px auto 0 auto;">
        
        <div class="plan-card">
            <h3 class="plan-name">Стартер</h3>
            <p class="plan-description">Для тех, кто хочет начать</p>
            <div class="plan-price">950₽<span>/мес</span></div>
            <p>1,500 токенов</p>
            <ul class="plan-includes">
                <li class="available"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>до 90 генераций</li>
                <li class="available"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>Режим редактирования</li>
                <li class="available"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>Улучшения качества (до 1080р)</li>
                <li class="available"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>Стандартная скорость</li>
                <li class="unavailable"><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>Pro-редактирование</li>
                <li class="unavailable"><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>Пополнение баланса</li>
                <li class="unavailable"><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>Приоритетный доступ к новым функциям</li>
            </ul>
            <form action="{{ url_for('create_payment') }}" method="POST">
                <input type="hidden" name="product_id" value="starter">
                <button type="submit" class="btn select-plan-btn">Выбрать</button>
            </form>
        </div>

        <div class="plan-card highlighted">
            <h3 class="plan-name">Оптимальный</h3>
            <p class="plan-description">Для продвинутых креаторов</p>
            <div class="plan-price">1850₽<span>/мес</span></div>
            <p>4,500 токенов</p>
            <ul class="plan-includes">
                <li class="available"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>до 90 генераций</li>
                <li class="available"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>Режим редактирования</li>
                <li class="available"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>Улучшения качества (до 1080р)</li>
                <li class="available"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>Стандартная скорость</li>
                <li class="available"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>Pro-редактирование</li>
                <li class="available"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>Пополнение баланса</li>
                <li class="unavailable"><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>Приоритетный доступ к новым функциям</li>
            </ul>
             <form action="{{ url_for('create_payment') }}" method="POST">
                <input type="hidden" name="product_id" value="optimal">
                <button type="submit" class="btn select-plan-btn">Выбрать</button>
            </form>
        </div>

        <div class="plan-card">
            <h3 class="plan-name">Pifly PRO</h3>
            <p class="plan-description">Для команд и продакшенов</p>
            <div class="plan-price">3490₽<span>/мес</span></div>
            <p>15,000 токенов</p>
            <ul class="plan-includes">
                <li class="available"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>до 90 генераций</li>
                <li class="available"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>Режим редактирования</li>
                <li class="available"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>Улучшения качества (до 1080р)</li>
                <li class="available"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>Стандартная скорость</li>
                <li class="available"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>Pro-редактирование</li>
                <li class="available"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>Пополнение баланса</li>
                <li class="available"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>Приоритетный доступ к новым функциям</li>
            </ul>
            <form action="{{ url_for('create_payment') }}" method="POST">
                <input type="hidden" name="product_id" value="pro">
                <button type="submit" class="btn select-plan-btn">Выбрать</button>
            </form>
        </div>
    </div>
    
    <div class="oferta-acceptance-container" style="max-width: 1100px; margin: 30px auto 0 auto; text-align: center;">
        <div class="checkbox-container" style="justify-content: center; padding: 15px; background-color: var(--surface-color); border-radius: 16px; border: 1px solid var(--border-color);">
            <input type="checkbox" id="billing-oferta-check" name="billing_oferta_check">
            <label for="billing-oferta-check" style="font-size: 0.9rem;">
                Я ознакомлен(а) и принимаю условия <a href="{{ url_for('oferta') }}" target="_blank" style="font-weight: 700;">публичной оферты</a>, включая рекуррентные платежи.
            </label>
        </div>
    </div>
    {% if current_user.is_authenticated %}
    <div style="max-width: 1100px; margin: 60px auto 0 auto; text-align: center; border-top: 1px solid var(--border-color); padding-top: 40px;">
        <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
            
            {% if current_user.subscription_status != 'free' and current_user.stripe_subscription_id %}
                <form action="{{ url_for('cancel_subscription') }}" method="POST" style="margin: 0;">
                    <button type="submit" class="btn btn-secondary">Отменить подписку</button>
                </form>
            {% else %}
                <button class="btn btn-disabled" disabled>Отменить подписку</button>
            {% endif %}

            <form action="{{ url_for('delete_account') }}" method="POST" style="margin: 0;">
                <button type="submit" class="btn btn-danger" onclick="return confirm('ВНИМАНИЕ: Это действие немедленно и навсегда удалит ваш аккаунт и все данные. Отменить его будет невозможно. Вы уверены?')">Удалить аккаунт</button>
            </form>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const ofertaCheck = document.getElementById('billing-oferta-check');
    const selectPlanButtons = document.querySelectorAll('.select-plan-btn');

    function togglePlanButtons() {
        selectPlanButtons.forEach(button => {
            button.disabled = !ofertaCheck.checked;
        });
    }

    togglePlanButtons();
    ofertaCheck.addEventListener('change', togglePlanButtons);
});
</script>
{% endblock %}
