{% extends "base_app.html" %}

{% block title %}Manage Your Plan{% endblock %}

{% block content %}
<div class="app-container" style="display: block; padding-bottom: 40px;">
    <div class="billing-header" style="max-width: 1100px; margin: 0 auto 40px auto;">
        <div class="current-plan-info">
            <h1>Manage your plan</h1>
            
            <p>Your current plan: <strong>{{ (current_user.current_plan or 'None').replace('_', ' ')|title }}</strong></p>
            {% if current_user.subscription_ends_at %}
                <p>
                    {% if current_user.subscription_status == 'canceled' %}
                        Subscription ends: 
                    {% else %}
                        Next billing date: 
                    {% endif %}
                    <strong>{{ current_user.subscription_ends_at.strftime('%B %d, %Y') }}</strong>
                </p>
            {% endif %}
            
            <p>You have <strong>{{ current_user.token_balance }}</strong> credits.</p>
            
            {% if current_user.subscription_status == 'active' %}
            <form action="{{ url_for('create_portal_session') }}" method="POST" style="margin-top: 20px;">
                <button class="btn btn-secondary" type="submit">Manage Payment & Invoices</button>
            </form>
            {% elif current_user.subscription_status != 'canceled' %}
            <p style="margin-top: 20px; color: var(--secondary-text-color);">You do not have an active subscription. Choose a plan below to start.</p>
            {% endif %}
        </div>
        </div>

    {% if current_user.subscription_status in ['active', 'canceled'] %}
    <div style="max-width: 1100px; margin: 60px auto 0 auto; text-align: center; border-top: 1px solid var(--border-color); padding-top: 40px;">
        <div style="display: flex; justify-content: center; gap: 20px;">
            
            {% if current_user.subscription_status == 'active' %}
            <form action="{{ url_for('cancel_subscription') }}" method="POST">
                <button type="submit" class="btn btn-secondary" onclick="return confirm('Are you sure you want to cancel your subscription? Your access will remain until the end of the current billing period.')">Cancel Subscription</button>
            </form>
            {% endif %}

            <form action="{{ url_for('delete_account') }}" method="POST">
                <button type="submit" class="btn btn-danger" onclick="return confirm('WARNING: This will immediately cancel your subscription and permanently delete your account and all data. This action cannot be undone. Are you sure?')">Delete Account</button>
            </form>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}
