{% extends "base_app.html" %}

{% block title %}Changer AI - Generate{% endblock %}

{% block head_extra %}
<style>
    /* Эти стили обеспечивают правильное отображение всех секций */
    #edit-view, #upscale-view, #video-view {
        display: none; /* Изначально все скрыты */
        flex-direction: column;
        gap: 20px;
        width: 100%;
    }
    #video-view .kling-controls {
        display: none; /* Изначально все наборы контролов для Kling скрыты */
        flex-direction: column;
        gap: 20px;
        width: 100%;
    }
    .kling-mode-btn {
        flex: 1; padding: 8px 20px; border-radius: 12px;
        border: none; background-color: transparent;
        color: var(--primary-text-color); cursor: pointer;
        font-family: 'Norms', sans-serif; font-size: 0.85rem; font-weight: 500;
        transition: all var(--transition-speed) ease; text-align: center;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .kling-mode-btn:not(.active):hover {
        background-color: rgba(0,0,0,0.05);
    }
    .kling-mode-btn.active {
        background-color: var(--accent-color);
        color: var(--accent-text-color);
        box-shadow: 0 4px 15px var(--accent-glow);
        font-weight: 700;
    }
</style>
{% endblock %}


{% block mode_selector %}
<div class="mode-selector">
    <button class="mode-btn active" data-mode="edit">Edit</button>
    <button class="mode-btn" data-mode="upscale">Upscale</button>
    <button class="mode-btn" data-mode="video">Video</button>
</div>
{% endblock %}

{% block content %}
<div class="app-container">
    <div class="content-wrapper" id="main-content-wrapper">
        
        <div id="edit-view">
            <div class="control-group">
                <div class="edit-mode-selector">
                    <button class="edit-mode-btn active" data-edit-mode="edit" data-description="720р quality output. Add or remove objects, create product shots and modify style or light.">Basic</button>
                    {% if current_user.current_plan in ['taste'] %}
                        <button class="edit-mode-btn feature-locked" disabled title="Please upgrade your plan to use this feature">Pro</button>
                    {% else %}
                        <button class="edit-mode-btn" data-edit-mode="autofix" data-description="Original image quality output. Add or remove objects, create product shots and modify style or light.">Pro</button>
                    {% endif %}
                </div>
            </div>
             <p id="edit-mode-description" class="mode-description"></p>
            <div class="image-inputs-container">
                <label for="image-file-edit-1" id="image-drop-area-edit-1" class="image-drop-area">
                    <div class="drop-placeholder">
                         <svg class="drop-placeholder-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" /></svg>
                        <span class="drop-placeholder-text">Drop Image or Click</span>
                    </div>
                    <img id="image-preview-edit-1" src="#" alt="Preview" class="image-preview-img">
                </label>
            </div>
            <input type="file" id="image-file-edit-1" name="image1" accept="image/*" style="display: none;">
            <div id="edit-controls-container" style="width:100%; display:flex; flex-direction:column; gap: 15px;">
                <div class="control-group">
                    <div id="templates-for-basic">
                         <div class="template-selector">
                            <button class="template-btn" data-prompt="Based on my [type the product you attached] create a scene where my product [describe the scene]"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>Create</button>
                            <button class="template-btn" data-prompt="Change the light of the image as in my description: [describe the new lighting]"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" /></svg>Relight</button>
                            <button class="template-btn" data-prompt="[Remove or Change] the [describe what you want to change]. Don’t change anything else."><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>Edit/Remove</button>
                            <button class="template-btn" data-prompt="Put [describe the character on your photo] from the photo into the [describe the scene]"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>Consistent character</button>
                        </div>
                    </div>
                    <div id="templates-for-pro" class="template-selector" style="display: none; justify-content: center; gap: 10px;">
                        <button type="button" class="template-btn" data-prompt="Change: Change the [describe what you want to change]. Don’t change anything else.">Change</button>
                        <button type="button" class="template-btn" data-prompt="Add: Add the [describe what you want to change]. Don’t change anything else.">Add</button>
                        <button type="button" class="template-btn" data-prompt="Remove: Remove the [describe what you want to change]. Don’t change anything else.">Remove</button>
                    </div>
                </div>
                <form id="edit-form" class="input-area">
                     <input type="text" id="prompt-edit" name="prompt" placeholder="Describe your changes in any language">
                </form>
            </div>
            <div class="submit-action-group">
                <button type="submit" id="submit-button-edit" class="submit-button-element">Generate</button>
                <div class="token-cost"><span>Estimated cost: 65</span><span class="token-coin"></span></div>
            </div>
        </div>

        <div id="upscale-view">
            <label for="image-file-upscale" id="image-drop-area-upscale" class="image-drop-area">
                <div class="drop-placeholder">
                    <svg class="drop-placeholder-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" /></svg>
                    <span class="drop-placeholder-text">Drop Image to Upscale</span>
                </div>
                <img id="image-preview-upscale" src="#" alt="Preview" class="image-preview-img">
            </label>
            <input type="file" id="image-file-upscale" name="image" accept="image/*" style="display: none;">
            <div style="display: flex; flex-direction: column; gap: 15px; width: 100%;">
                <div class="control-group">
                    <label>Resolution</label>
                    <div class="resolution-selector">
                        <button class="resolution-btn active" data-value="2">x2</button>
                        {% if current_user.current_plan in ['free', 'taste', 'trial'] %}
                            <button class="resolution-btn feature-locked" disabled title="Please upgrade your plan to use this feature">x4</button>
                        {% else %}
                            <button class="resolution-btn" data-value="4">x4</button>
                        {% endif %}
                        {% if current_user.current_plan not in ['pro'] %}
                            <button class="resolution-btn feature-locked" disabled title="Please upgrade your plan to use this feature">x8</button>
                        {% else %}
                            <button class="resolution-btn" data-value="8">x8</button>
                        {% endif %}
                    </div>
                </div>
                <div class="control-group">
                    <div class="slider-container">
                        <div class="slider-header"><label for="creativity-slider">Creativity</label><span class="slider-value" id="creativity-value">30</span></div>
                        <input type="range" id="creativity-slider" min="0" max="100" value="30" class="custom-slider">
                    </div>
                </div>
                <div class="control-group">
                    <div class="slider-container">
                        <div class="slider-header"><label for="resemblance-slider">Resemblance</label><span class="slider-value" id="resemblance-value">20</span></div>
                        <input type="range" id="resemblance-slider" min="0" max="100" value="20" class="custom-slider">
                    </div>
                </div>
                <div class="control-group">
                    <div class="slider-container">
                        <div class="slider-header"><label for="hdr-slider">HDR</label><span class="slider-value" id="hdr-value">10</span></div>
                        <input type="range" id="hdr-slider" min="0" max="100" value="10" class="custom-slider">
                    </div>
                </div>
                <div class="control-group">
                    <div class="slider-container">
                        <div class="slider-header"><label for="fractality-slider-upscale">Fractality</label><span class="slider-value" id="fractality-value-upscale">18</span></div>
                        <input type="range" id="fractality-slider-upscale" min="1" max="100" value="18" class="custom-slider">
                    </div>
                </div>
            </div>
            <div class="submit-action-group">
                <button type="submit" id="submit-button-upscale" class="submit-button-element">Upscale</button>
                <div id="token-cost-upscale" class="token-cost"><span>Estimated cost: 17</span><span class="token-coin"></span></div>
            </div>
        </div>

        <div id="video-view">
            <div class="control-group">
                <div class="edit-mode-selector">
                    <button class="kling-mode-btn active" data-kling-mode="2.0">Kling 2.0</button>
                    <button class="kling-mode-btn" data-kling-mode="2.1">Kling 2.1</button>
                    <button class="kling-mode-btn" data-kling-mode="2.1-pro">Kling 2.1 Pro</button>
                </div>
            </div>

            <div id="kling-2-0-controls" class="kling-controls">
                <div class="control-group">
                    <label>Start frame (optional)</label>
                    <label for="image-file-kling-2-0" class="image-drop-area">
                         <div class="drop-placeholder"><svg class="drop-placeholder-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" /></svg><span class="drop-placeholder-text">Drop Start Frame</span></div>
                         <img id="image-preview-kling-2-0" src="#" alt="Preview" class="image-preview-img">
                    </label>
                    <input type="file" id="image-file-kling-2-0" accept="image/*" style="display: none;">
                </div>
                <div class="control-group">
                    <label>Negative prompt</label>
                    <div class="input-area"><input type="text" id="negative-prompt-2-0" placeholder="e.g. blurry, low quality"></div>
                </div>
                <div class="control-group">
                    <div class="slider-container">
                         <div class="slider-header"><label for="creativity-slider-kling">Creativity</label><span class="slider-value" id="creativity-value-kling">30</span></div>
                         <input type="range" id="creativity-slider-kling" min="0" max="100" value="30" class="custom-slider">
                    </div>
                </div>
                <div class="control-group"><label>Aspect Ratio</label><div class="resolution-selector"><button class="resolution-btn active" data-value="16:9">16:9</button><button class="resolution-btn" data-value="9:16">9:16</button><button class="resolution-btn" data-value="1:1">1:1</button></div></div>
                <div class="control-group"><label>Duration</label><div class="resolution-selector"><button class="resolution-btn active" data-value="5">5 sec</button><button class="resolution-btn" data-value="10">10 sec</button></div></div>
                <div class="control-group">
                    <label>Prompt</label>
                    <div class="input-area"><input type="text" id="prompt-kling-2-0" placeholder="Describe your video"></div>
                </div>
            </div>

            <div id="kling-2-1-controls" class="kling-controls">
                <div class="control-group">
                    <label>Start frame (optional)</label>
                    <label for="image-file-kling-2-1" class="image-drop-area">
                         <div class="drop-placeholder"><svg class="drop-placeholder-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" /></svg><span class="drop-placeholder-text">Drop Start Frame</span></div>
                         <img id="image-preview-kling-2-1" src="#" alt="Preview" class="image-preview-img">
                    </label>
                    <input type="file" id="image-file-kling-2-1" accept="image/*" style="display: none;">
                </div>
                <div class="control-group">
                    <label>Negative prompt</label>
                    <div class="input-area"><input type="text" id="negative-prompt-2-1" placeholder="e.g. text, watermark"></div>
                </div>
                <div class="control-group"><label>Resolution</label><div class="resolution-selector"><button class="resolution-btn active" data-value="720p">720p</button><button class="resolution-btn" data-value="1080p">1080p</button></div></div>
                <div class="control-group"><label>Duration</label><div class="resolution-selector"><button class="resolution-btn active" data-value="5">5 sec</button><button class="resolution-btn" data-value="10">10 sec</button></div></div>
                <div class="control-group">
                    <label>Prompt</label>
                    <div class="input-area"><input type="text" id="prompt-kling-2-1" placeholder="Describe your video"></div>
                </div>
            </div>

            <div id="kling-2-1-pro-controls" class="kling-controls">
                <div class="control-group">
                    <label>Start frame (optional)</label>
                    <label for="image-file-kling-2-1-pro" class="image-drop-area">
                         <div class="drop-placeholder"><svg class="drop-placeholder-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" /></svg><span class="drop-placeholder-text">Drop Start Frame</span></div>
                         <img id="image-preview-kling-2-1-pro" src="#" alt="Preview" class="image-preview-img">
                    </label>
                    <input type="file" id="image-file-kling-2-1-pro" accept="image/*" style="display: none;">
                </div>
                 <div class="control-group">
                    <label>Negative prompt</label>
                    <div class="input-area"><input type="text" id="negative-prompt-2-1-pro" placeholder="e.g. low resolution"></div>
                </div>
                <div class="control-group"><label>Aspect Ratio</label><div class="resolution-selector"><button class="resolution-btn active" data-value="16:9">16:9</button><button class="resolution-btn" data-value="9:16">9:16</button><button class="resolution-btn" data-value="1:1">1:1</button></div></div>
                <div class="control-group"><label>Duration</label><div class="resolution-selector"><button class="resolution-btn active" data-value="5">5 sec</button><button class="resolution-btn" data-value="10">10 sec</button></div></div>
                 <div class="control-group">
                    <label>Prompt</label>
                    <div class="input-area"><input type="text" id="prompt-kling-2-1-pro" placeholder="Describe your video"></div>
                </div>
            </div>

            <div class="submit-action-group">
                <button type="submit" id="submit-button-video" class="submit-button-element">Generate Video</button>
                <div class="token-cost"><span>Estimated cost: 150</span><span class="token-coin"></span></div>
            </div>
        </div>
        
    </div>
    <div id="result-area-right">
         <div id="history-placeholder">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" /></svg>
            Your generations will appear here.
         </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- ОБЪЯВЛЕНИЕ ПЕРЕМЕННЫХ ---
    const tokenBalanceDisplaySpan = document.getElementById('token-balance-display');
    const mainContentWrapper = document.getElementById('main-content-wrapper');
    const resultAreaRight = document.getElementById('result-area-right');
    const appModeButtons = document.querySelectorAll('.mode-btn');
    
    // Views
    const editView = document.getElementById('edit-view');
    const upscaleView = document.getElementById('upscale-view');
    const videoView = document.getElementById('video-view');

    // Элементы для режима Edit
    const editModeButtons = document.querySelectorAll('#edit-view .edit-mode-btn');
    const editModeDescription = document.getElementById('edit-mode-description');
    const templatesForBasic = document.getElementById('templates-for-basic');
    const templatesForPro = document.getElementById('templates-for-pro');
    const allTemplateButtons = document.querySelectorAll('.template-btn');
    const promptInputEdit = document.getElementById('prompt-edit');
    const editForm = document.getElementById('edit-form');
    const imageFileInputEdit1 = document.getElementById('image-file-edit-1');

    // Элементы для режима Upscale
    const upscaleImageInput = document.getElementById('image-file-upscale');
    
    // Элементы для режима Video
    const klingModeButtons = document.querySelectorAll('#video-view .kling-mode-btn');
    const klingControls = document.querySelectorAll('.kling-controls');

    // Переменные состояния
    const historyPlaceholder = document.getElementById('history-placeholder');
    let currentLoaderId = null;

    // --- ОСНОВНЫЕ ФУНКЦИИ (без изменений) ---
    function showError(message) {
        const errorBox = document.getElementById('error-box');
        if (!errorBox) { console.error("Error box not found"); return; }
        errorBox.textContent = message;
        errorBox.style.display = 'block';
        setTimeout(() => { errorBox.style.display = 'none'; }, 5000);
    }

    function resetLeftPanel() {
        mainContentWrapper.classList.remove('disabled');
        document.querySelectorAll('.image-preview-img').forEach(img => {
            img.src = '#';
            img.style.display = 'none';
        });
        document.querySelectorAll('.drop-placeholder').forEach(p => {
            if (p) p.style.display = 'flex';
        });
        
        const fileInputs = [
            imageFileInputEdit1, upscaleImageInput, 
            document.getElementById('image-file-kling-2-0'), 
            document.getElementById('image-file-kling-2-1'), 
            document.getElementById('image-file-kling-2-1-pro')
        ];
        fileInputs.forEach(input => { if (input) input.value = ''; });
        
        if (promptInputEdit) promptInputEdit.value = '';
        allTemplateButtons.forEach(btn => btn.classList.remove('active'));
    }

    function startLoading() {
        mainContentWrapper.classList.add('disabled');
        if (historyPlaceholder) historyPlaceholder.style.display = 'none';
        currentLoaderId = 'loader-' + Date.now();
        const loaderHtml = `<div class="loader-container" id="${currentLoaderId}"><div class="pulsating-dot"></div></div>`;
        resultAreaRight.insertAdjacentHTML('afterbegin', loaderHtml);
    }

    function createHistoryItem(url) {
        const item = document.createElement('div');
        item.className = 'history-item';
        const fileExtension = url.split('?')[0].split('.').pop().toLowerCase();
        if (['mp4', 'webm', 'mov'].includes(fileExtension)) {
            item.innerHTML = `<video src="${url}" class="history-item-image" controls autoplay loop muted></video>`;
        } else {
            item.innerHTML = `<img src="${url}" alt="Generated Image" class="history-item-image">`;
        }
        item.innerHTML += `
            <a href="${url}" class="download-action-link" download title="Download" target="_blank" rel="noopener noreferrer">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            </a>`;
        return item;
    }

    function stopLoading(newUrl) {
        mainContentWrapper.classList.remove('disabled');
        const loader = document.getElementById(currentLoaderId);
        if (loader) {
            if (newUrl) {
                const newItem = createHistoryItem(newUrl);
                loader.replaceWith(newItem);
            } else {
                loader.remove();
            }
        }
        if (resultAreaRight.childElementCount === 0 && historyPlaceholder) {
             historyPlaceholder.style.display = 'flex';
        }
        currentLoaderId = null;
    }
    
    function handleFileSelect(file, previewElementId) {
        const previewElement = document.getElementById(previewElementId);
        const dropArea = previewElement.parentElement;
        const placeholder = dropArea.querySelector('.drop-placeholder');
        const reader = new FileReader();

        reader.onload = (e) => {
            previewElement.src = e.target.result;
            previewElement.style.display = 'block';
            if (placeholder) placeholder.style.display = 'none';
        }
        reader.readAsDataURL(file);
    }

    function setupDragAndDrop(dropArea, fileInputElement) {
        if (!dropArea || !fileInputElement) return;
        const previewImgId = dropArea.querySelector('.image-preview-img').id;
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
        });
        dropArea.addEventListener('dragenter', () => dropArea.classList.add('dragover'));
        dropArea.addEventListener('dragleave', () => dropArea.classList.remove('dragover'));
        dropArea.addEventListener('drop', (e) => {
            dropArea.classList.remove('dragover');
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                fileInputElement.files = e.dataTransfer.files;
                handleFileSelect(fileInputElement.files[0], previewImgId);
            }
        });
        fileInputElement.addEventListener('change', () => {
            if (fileInputElement.files && fileInputElement.files[0]) {
                 handleFileSelect(fileInputElement.files[0], previewImgId);
            }
        });
    }
    
    function pollForResult(predictionId) {
        const interval = setInterval(async () => {
            try {
                const pollResponse = await fetch(`/get-result/${predictionId}`);
                if (!pollResponse.ok) {
                    const errorData = await pollResponse.json().catch(() => ({error: `Polling failed with status: ${pollResponse.statusText}`}));
                    throw new Error(errorData.error);
                }
                const pollData = await pollResponse.json();

                if (pollData.status === 'completed') {
                    clearInterval(interval);
                    stopLoading(pollData.output_url);
                    if (pollData.new_token_balance !== undefined && tokenBalanceDisplaySpan) {
                        tokenBalanceDisplaySpan.textContent = pollData.new_token_balance;
                    }
                } else if (pollData.status === 'failed') {
                    clearInterval(interval);
                    showError(pollData.error || 'Generation failed. Your tokens have been refunded.');
                    stopLoading(null);
                    if (pollData.new_token_balance !== undefined && tokenBalanceDisplaySpan) {
                        tokenBalanceDisplaySpan.textContent = pollData.new_token_balance;
                    }
                }
            } catch (error) {
                clearInterval(interval);
                showError("Error checking result: " + error.message);
                stopLoading(null);
            }
        }, 3000);

        setTimeout(() => {
            const loader = document.getElementById(currentLoaderId);
            if(loader) {
                clearInterval(interval);
                showError("Generation is taking longer than expected. The result will appear here when ready.");
            }
        }, 300000);
    }

    async function handleImageProcessing(event) {
        event.preventDefault();
        const currentMode = document.querySelector('.mode-btn.active').dataset.mode;
        startLoading();
        const formData = new FormData();
        formData.append('mode', currentMode);
    
        if (currentMode === 'edit') {
            const editMode = document.querySelector('#edit-view .edit-mode-btn.active').dataset.editMode;
            formData.append('edit_mode', editMode);
            const imageFile = document.getElementById('image-file-edit-1').files[0];
            if (!imageFile) {
                showError("Please select an image to edit.");
                stopLoading(null); return;
            }
            formData.append('image', imageFile);
            formData.append('prompt', document.getElementById('prompt-edit').value);
    
        } else if (currentMode === 'upscale') {
            const imageFile = document.getElementById('image-file-upscale').files[0];
            if (!imageFile) {
                showError("Please select an image to upscale.");
                stopLoading(null); return;
            }
            formData.append('image', imageFile);
            formData.append('scale_factor', document.querySelector('#upscale-view .resolution-selector .resolution-btn.active').dataset.value);
            formData.append('creativity', document.getElementById('creativity-slider').value);
            formData.append('resemblance', document.getElementById('resemblance-slider').value);
            formData.append('dynamic', document.getElementById('hdr-slider').value);
            formData.append('fractality', document.getElementById('fractality-slider-upscale').value);
    
        } else if (currentMode === 'video') {
            const activeKlingMode = document.querySelector('#video-view .kling-mode-btn.active').dataset.klingMode;
            formData.append('kling_mode', activeKlingMode);
            
            let imageFile, promptValue, negativePromptValue, duration, aspectRatio, resolution, creativity;
            
            const activeControlsId = `kling-${activeKlingMode}-controls`;

            imageFile = document.getElementById(`image-file-${activeKlingMode}`).files[0];
            promptValue = document.getElementById(`prompt-kling-${activeKlingMode}`).value;
            negativePromptValue = document.getElementById(`negative-prompt-${activeKlingMode}`).value;
            duration = document.querySelector(`#${activeControlsId} .resolution-selector:last-of-type button.active`).dataset.value;

            if (activeKlingMode === '2.0' || activeKlingMode === '2.1-pro') {
                aspectRatio = document.querySelector(`#${activeControlsId} .resolution-selector:first-of-type button.active`).dataset.value;
                formData.append('aspect_ratio', aspectRatio);
            }
            if (activeKlingMode === '2.0') {
                creativity = document.getElementById('creativity-slider-kling').value;
                formData.append('creativity', creativity);
            }
            if (activeKlingMode === '2.1') {
                resolution = document.querySelector(`#${activeControlsId} .resolution-selector:first-of-type button.active`).dataset.value;
                formData.append('resolution', resolution);
            }
            
            if (imageFile && imageFile.size > 0) formData.append('image', imageFile);
            formData.append('prompt', promptValue);
            formData.append('negative_prompt', negativePromptValue);
            formData.append('duration', duration);
        }
    
        try {
            const response = await fetch("{{ url_for('process_image') }}", {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (!response.ok) { throw new Error(data.error || 'Unknown server error'); }
            if (data.new_token_balance !== undefined && tokenBalanceDisplaySpan) {
                tokenBalanceDisplaySpan.textContent = data.new_token_balance;
            }
            pollForResult(data.prediction_id);
        } catch (error) {
            showError("An error occurred: " + error.message);
            stopLoading(null);
        }
    }

    // --- НАВЕШИВАНИЕ ОБРАБОТЧИКОВ ---

    // ИСПРАВЛЕНИЕ 1: Логика переключения главных режимов
    appModeButtons.forEach(button => {
        button.addEventListener('click', () => {
            const currentMode = button.dataset.mode;
            appModeButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            editView.style.display = 'none';
            upscaleView.style.display = 'none';
            videoView.style.display = 'none';
            
            resetLeftPanel();

            if (currentMode === 'edit') {
                editView.style.display = 'flex';
                // Автоматически кликаем на активный под-режим
                document.querySelector('#edit-view .edit-mode-btn.active')?.click();
            } else if (currentMode === 'upscale') {
                upscaleView.style.display = 'flex';
            } else if (currentMode === 'video') {
                videoView.style.display = 'flex';
                // Автоматически кликаем на активный под-режим
                document.querySelector('#video-view .kling-mode-btn.active')?.click();
            }
        });
    });

    // Логика для Basic/Pro (работает)
    editModeButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            if (e.currentTarget.disabled) return;
            const editMode = e.currentTarget.dataset.editMode;
            editModeButtons.forEach(btn => btn.classList.remove('active'));
            e.currentTarget.classList.add('active');
            editModeDescription.textContent = e.currentTarget.dataset.description;
    
            const tokenCostSpan = document.querySelector('#edit-view .token-cost span');
            if (editMode === 'autofix') {
                templatesForBasic.style.display = 'none';
                templatesForPro.style.display = 'flex';
                if(tokenCostSpan) tokenCostSpan.textContent = 'Estimated cost: 100';
            } else {
                templatesForBasic.style.display = 'block';
                templatesForPro.style.display = 'none';
                if(tokenCostSpan) tokenCostSpan.textContent = 'Estimated cost: 65';
            }
        });
    });

    // ИСПРАВЛЕНИЕ 2: Новая, правильная логика для Kling
    klingModeButtons.forEach(button => {
        button.addEventListener('click', () => {
            const klingMode = button.dataset.klingMode;
            klingModeButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            // Прячем все панели с контролами
            klingControls.forEach(controlDiv => {
                controlDiv.style.display = 'none';
            });

            // Показываем только нужную
            const activeControlDiv = document.getElementById(`kling-${klingMode}-controls`);
            if (activeControlDiv) {
                activeControlDiv.style.display = 'flex';
            }
        });
    });
    
    // Остальные обработчики
    allTemplateButtons.forEach(button => {
        button.addEventListener('click', () => {
            promptInputEdit.value = button.dataset.prompt;
            promptInputEdit.focus();
        });
    });
    
    promptInputEdit.addEventListener('input', () => {
        allTemplateButtons.forEach(btn => btn.classList.remove('active'));
    });

    document.querySelectorAll('.resolution-selector .resolution-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const parentSelector = e.currentTarget.closest('.resolution-selector');
            parentSelector.querySelectorAll('.resolution-btn').forEach(btn => btn.classList.remove('active'));
            e.currentTarget.classList.add('active');
        });
    });

    const setupSlider = (sliderId, valueId) => {
        const slider = document.getElementById(sliderId);
        const valueDisplay = document.getElementById(valueId);
        if(slider && valueDisplay) {
            valueDisplay.textContent = slider.value;
            slider.addEventListener('input', (event) => {
                valueDisplay.textContent = event.target.value;
            });
        }
    };
    setupSlider('creativity-slider', 'creativity-value');
    setupSlider('resemblance-slider', 'resemblance-value');
    setupSlider('hdr-slider', 'hdr-value');
    setupSlider('fractality-slider-upscale', 'fractality-value-upscale');
    setupSlider('creativity-slider-kling', 'creativity-value-kling');

    document.getElementById('submit-button-edit').addEventListener('click', handleImageProcessing);
    document.getElementById('submit-button-upscale').addEventListener('click', handleImageProcessing);
    document.getElementById('submit-button-video').addEventListener('click', handleImageProcessing);

    setupDragAndDrop(document.getElementById('image-drop-area-edit-1'), imageFileInputEdit1);
    setupDragAndDrop(document.getElementById('image-drop-area-upscale'), upscaleImageInput);
    setupDragAndDrop(document.getElementById('image-drop-area-kling-2-0'), document.getElementById('image-file-kling-2-0'));
    setupDragAndDrop(document.getElementById('image-drop-area-kling-2-1'), document.getElementById('image-file-kling-2-1'));
    setupDragAndDrop(document.getElementById('image-drop-area-kling-2-1-pro'), document.getElementById('image-file-kling-2-1-pro'));
    
    // --- ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ ---
    if (appModeButtons.length > 0) {
        appModeButtons[0].click();
    }
});
</script>
{% endblock %}
