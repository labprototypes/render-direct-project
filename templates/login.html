{% extends "base_security.html" %}

{% block title %}Login / Sign Up{% endblock %}

{% block content %}
    <h2>Login or create an account</h2>
    
    <div id="firebaseui-auth-container"></div>
    <div id="loader" style="text-align: center; padding: 20px; display: none;">Loading...</div>

    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejsui/latest/firebaseui.css" />
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejsui/latest/firebaseui.js"></script>

    <script>
        // Этот код будет использовать глобальный объект 'firebase', который создается compat-скриптами выше
        
        const firebaseConfig = {
          apiKey: "AIzaSyA7IQDOcbIA18OHSHSJTKNqEwjzNKiY8hw",
          authDomain: "pifly-cf45f.firebaseapp.com",
          projectId: "pifly-cf45f",
          storageBucket: "pifly-cf45f.firebasestorage.app",
          messagingSenderId: "516997916662",
          appId: "1:516997916662:web:dd3d34e3160d7176ff09d7",
          measurementId: "G-GTKNFZFZXY"
        };

        // Используем старый, но надежный синтаксис, который теперь должен работать
        firebase.initializeApp(firebaseConfig);

        const uiConfig = {
            callbacks: {
                signInSuccessWithAuthResult: function(authResult, redirectUrl) {
                    document.getElementById('loader').style.display = 'block';
                    document.getElementById('firebaseui-auth-container').style.display = 'none';

                    authResult.user.getIdToken().then(function(idToken) {
                        fetch('/session-login', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ idToken: idToken })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                window.location.assign('/');
                            } else {
                                alert('Login failed: ' + data.message);
                                location.reload(); 
                            }
                        });
                    });
                    return false;
                },
                uiShown: function() {
                    document.getElementById('loader').style.display = 'none';
                }
            },
            signInFlow: 'popup',
            signInSuccessUrl: '/', 
            signInOptions: [
              firebase.auth.GoogleAuthProvider.PROVIDER_ID,
              firebase.auth.EmailAuthProvider.PROVIDER_ID
            ],
            tosUrl: '/terms',
            privacyPolicyUrl: '/privacy'
        };

        // Теперь вызов firebase.auth() не должен вызывать ошибку, так как мы используем compat-библиотеки
        const ui = new firebaseui.auth.AuthUI(firebase.auth());
        ui.start('#firebaseui-auth-container', uiConfig);
    </script>
{% endblock %}
